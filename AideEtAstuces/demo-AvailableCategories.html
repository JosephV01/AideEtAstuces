<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Démonstration Catégories - MyCustomDesk</title>
    <link rel="stylesheet" href="demo-elements.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI Variable', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        /* Styles pour la démonstration */
        .demo-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 100%;
            margin: 0 auto;
            padding: 0 20px;
        }

        .demo-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            align-items: stretch;
        }

        .demo-messages-panel {
            height: 100%;
            min-height: 550px;
            background: transparent;
            overflow-y: auto;
        }

        .demo-left-panel {
            flex: 1;
            min-width: 0;
        }

        .demo-right-panel {
            flex: 0 0 650px;
        }

        /* Styles pour la bulle de démonstration */
        .demo-bubble-container {
            width: 100%;
            height: 100%;
            min-width: 0;
            min-height: 400px;
            margin: 0;
            background: transparent;
            position: relative;
            overflow: hidden;
        }

        .demo-bubble-border {
            border: 2px solid #d1d1d1;
            border-radius: 15px;
            padding: 6px;
            background: #ffffff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .demo-bubble-header {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            margin-bottom: 6px;
            min-height: 0;
        }

        .demo-bubble-title {
            font-size: 20px;
            font-weight: bold;
            color: #000000;
        }

        .demo-bubble-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin: 6px;
            min-height: 0;
            overflow: hidden;
        }

        .demo-bubble-canvas {
            position: relative;
            background: #2D2D2D;
            width: 100%;
            height: 100%;
            border-radius: 8px;
            overflow: visible;
        }

        /* Ajustement de la bulle pour les nouvelles dimensions */
        .demo-bubble-canvas .dynamic-border {
            position: absolute;
            border: 2px solid white;
            background: #2D2D30;
            border-radius: 6px;
            width: 400px;
            height: 160px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }

        /* Ajustement de l'étiquette pour la nouvelle bulle */
        .demo-bubble-canvas .label-border {
            position: absolute;
            background: #2D2D30;
            border: 1px solid white;
            border-radius: 3px;
            padding: 3px 6px;
            height: 20px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            width: auto;
            min-width: fit-content;
            margin-top: -100px; /* Positionner au-dessus de la bulle */
        }

        /* Ajustement de la poignée pour la nouvelle bulle */
        .demo-bubble-canvas .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: white;
            border: 1px solid black;
            border-radius: 50%;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            margin-left: 198px; /* Positionner à droite de la bulle */
            margin-top: 78px; /* Positionner en bas de la bulle */
            z-index: 999;
            transition: all 0.3s ease;
        }

        .demo-progress-window {
            width: 100%;
            background: #ffffff;
            border: 2px solid #c0c0c0;
            border-radius: 20px;
            padding: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            display: block;
        }

        .demo-progress-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .demo-progress-header {
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 8px;
        }

        .demo-progress-title {
            font-size: 18px;
            font-weight: bold;
            color: #2d2d30;
            margin-bottom: 4px;
        }

        .demo-progress-subtitle {
            font-size: 12px;
            color: #666666;
        }

        .demo-progress-body {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .demo-progress-instruction {
            font-size: 13px;
            color: #2d2d30;
            line-height: 1.4;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #0078d4;
        }

        .demo-progress-bar-container {
            background: #e0e0e0;
            border-radius: 8px;
            height: 16px;
            overflow: hidden;
        }

        .demo-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #0078d4, #106ebe);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .demo-progress-controls {
            display: flex;
            justify-content: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .demo-button {
            padding: 6px 12px;
            border: 2px solid #0078d4;
            background: #0078d4;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .demo-button:hover {
            background: #106ebe;
            border-color: #106ebe;
        }

        .demo-button.secondary {
            background: white;
            color: #0078d4;
        }

        .demo-button.secondary:hover {
            background: #f0f8ff;
        }

        .demo-button:disabled {
            background: #cccccc;
            border-color: #cccccc;
            cursor: not-allowed;
        }

        .main-container {
            width: 100%;
            height: 550px;
            min-width: 0;
            margin: 0;
            background: transparent;
            position: relative;
            overflow: hidden;
        }

        .main-border {
            border: 2px solid #d1d1d1;
            border-radius: 15px;
            padding: 6px;
            background: #ffffff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-grid {
            flex: 1;
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: 8px;
            margin: 6px;
            min-height: 0;
            overflow: hidden;
        }

        /* En-tête */
        .header {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            margin-bottom: 6px;
            min-height: 0;
        }

        .title {
            font-size: 20px;
            font-weight: bold;
            color: #000000;
        }

        .close-button {
            width: 30px;
            height: 30px;
            border: none;
            background: transparent;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-button:hover {
            background: #e5e5e5;
        }

        /* Contenu principal */
        .main-content {
            display: grid;
            grid-template-columns: 220px 3px 1fr;
            gap: 0;
            margin-bottom: 6px;
            min-height: 0;
            overflow: hidden;
        }

        /* Volet des catégories */
        .categories-panel {
            width: 220px;
            background: #f0f0f0;
            border-radius: 6px;
            padding: 8px 6px;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .categories-title {
            font-size: 12px;
            font-weight: bold;
            color: #000000;
            margin-bottom: 4px;
            flex-shrink: 0;
            text-align: center;
        }

        .categories-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .category-button {
            width: 100%;
            padding: 6px 8px;
            margin: 2px 0;
            border: none;
            background: transparent;
            text-align: center;
            cursor: pointer;
            border-radius: 3px;
            font-size: 14px;
            color: #000000;
            transition: all 0.2s;
            line-height: 1.2;
        }

        .category-button:hover {
            background: #e0e0e0;
        }

        .category-button.selected {
            background: #005ea2;
            color: white;
            font-weight: bold;
        }

        /* Séparateur */
        .splitter {
            background: #d1d1d1;
            width: 1px;
            cursor: col-resize;
        }

        /* Zone des images */
        .images-panel {
            background: #f0f0f0;
            border-radius: 6px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .current-category-title {
            font-size: 16px;
            font-weight: bold;
            color: #000000;
            margin-bottom: 8px;
            flex-shrink: 0;
        }

        .images-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0;
            min-height: 0;
        }

        .images-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 0;
        }

        .image-button {
            width: 120px;
            height: 90px;
            border: 2px solid transparent;
            background: transparent;
            cursor: pointer;
            border-radius: 3px;
            overflow: hidden;
            transition: border-color 0.2s;
        }

        .image-button:hover {
            border-color: #cccccc;
        }

        .image-button.selected {
            border: 3px solid #005ea2;
        }

        .image-button img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Barre d'état */
        .status-bar {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            min-height: 0;
            flex-shrink: 0;
        }

        .status-text {
            color: #666666;
            font-size: 12px;
        }

        .action-buttons {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .action-button {
            height: 26px;
            min-width: 120px;
            border: 1px solid #cccccc;
            background: #ffffff;
            cursor: pointer;
            border-radius: 3px;
            font-size: 11px;
            padding: 0 12px;
            white-space: nowrap;
        }

        .action-button:hover {
            background: #f0f0f0;
        }

        .action-button:disabled {
            background: #f5f5f5;
            color: #999999;
            cursor: not-allowed;
        }

        .action-button.primary {
            background: #005ea2;
            color: white;
            border-color: #005ea2;
            min-width: 100px;
        }

        .action-button.primary:hover:not(:disabled) {
            background: #004080;
        }

        /* Scrollbar personnalisée */
        .categories-list::-webkit-scrollbar,
        .images-container::-webkit-scrollbar {
            width: 8px;
        }

        .categories-list::-webkit-scrollbar-track,
        .images-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .categories-list::-webkit-scrollbar-thumb,
        .images-container::-webkit-scrollbar-thumb {
            background: #cccccc;
            border-radius: 4px;
        }

        .categories-list::-webkit-scrollbar-thumb:hover,
        .images-container::-webkit-scrollbar-thumb:hover {
            background: #999999;
        }

        /* Styles pour la démonstration */
        .demo-highlight {
            animation: demoPulse 1s ease-in-out infinite;
            box-shadow: 0 0 10px #0078d4 !important;
        }

        @keyframes demoPulse {
            0% { 
                opacity: 0.3; 
                box-shadow: 0 0 0 0 rgba(0, 120, 212, 0.7);
            }
            50% { 
                opacity: 1; 
                box-shadow: 0 0 0 8px rgba(0, 120, 212, 0);
            }
            100% { 
                opacity: 0.3; 
                box-shadow: 0 0 0 0 rgba(0, 120, 212, 0.7);
            }
        }

        @keyframes demoPulseOrange {
            0% { 
                opacity: 0.3; 
                box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.7);
            }
            50% { 
                opacity: 1; 
                box-shadow: 0 0 0 8px rgba(255, 107, 53, 0);
            }
            100% { 
                opacity: 0.3; 
                box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.7);
            }
        }

        .category-button.demo-highlight {
            background: #0078d4 !important;
            color: white !important;
            font-weight: bold !important;
        }

        .category-button.demo-highlight-orange {
            animation: demoPulseOrange 1s ease-in-out infinite;
            background: #ff6b35 !important;
            color: #ffffff !important;
            font-weight: bold !important;
            box-shadow: 0 0 10px #ff6b35 !important;
        }

        .image-button.demo-highlight {
            border: 3px solid #0078d4 !important;
            box-shadow: 0 0 15px #0078d4 !important;
        }

        /* Styles pour la mise en surbrillance des boutons */
        .button-highlight {
            position: absolute;
            border: 3px solid #ff6b35;
            border-radius: 4px;
            background: rgba(255, 107, 53, 0.1);
            pointer-events: none;
            z-index: 999;
            animation: demoPulseOrange 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0% { 
                opacity: 0.3; 
                box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.7);
            }
            50% { 
                opacity: 1; 
                box-shadow: 0 0 0 8px rgba(255, 107, 53, 0);
            }
            100% { 
                opacity: 0.3; 
                box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.7);
            }
        }

        /* Styles pour les messages explicatifs */
        .demo-message {
            position: relative;
            background: #ffffff;
            color: #2d2d30;
            padding: 14px 16px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            margin: 10px auto;
            max-width: 650px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
            border: 1px solid #e5e5e5;
        }

        .demo-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .demo-message .message-title {
            margin: 0 0 10px 0;
            font-size: 20px;
            font-weight: bold;
            color: #2d2d30;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e5e5;
        }

        .demo-message .message-section {
            margin: 8px 0;
            padding: 10px 12px;
            background: #f8f9fb;
            border-radius: 8px;
            border-left: 4px solid #cfd8dc;
        }

        .demo-message .section-title {
            font-size: 16px;
            font-weight: bold;
            margin: 0 0 6px 0;
            color: #2d2d30;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .demo-message .section-content {
            font-size: 15px;
            line-height: 1.45;
            color: #333333;
            margin: 0;
        }

        .demo-message .action-required {
            background: rgba(255, 107, 53, 0.2);
            border-left-color: #ff6b35;
            position: relative;
        }

        .demo-message .action-required::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 3px solid #ff6b35;
            border-radius: 10px;
            animation: actionPulse 1s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes actionPulse {
            0% { 
                opacity: 0.3; 
                box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.7);
            }
            50% { 
                opacity: 1; 
                box-shadow: 0 0 0 8px rgba(255, 107, 53, 0);
            }
            100% { 
                opacity: 0.3; 
                box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.7);
            }
        }

        .demo-message .tip-section {
            background: #fff8e1;
            border-left-color: #ffcc80;
        }

        .demo-message .validation-button {
            display: block;
            width: 100%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 12px rgba(40, 167, 69, 0.28);
        }

        .demo-message .validation-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .demo-message .validation-button:active {
            transform: translateY(0);
        }

        .demo-message .close-btn {
            position: absolute;
            top: 5px;
            right: 8px;
            background: none;
            border: none;
            color: #333333;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .demo-message .close-btn:hover {
            background: rgba(0,0,0,0.06);
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <!-- Fenêtre de progression de démonstration -->
        <div class="demo-progress-window" id="demoProgressWindow">
            <div class="demo-progress-content">
                <div class="demo-progress-header">
                    <div class="demo-progress-title">📚 Démonstration : Guide d'utilisation complet de la Bibliothèque</div>
                    <div class="demo-progress-subtitle">Guide interactif pour explorer les catégories, puis sélectionner et appliquer un fond d'écran et un fond de bulle</div>
                </div>
                
                <div class="demo-progress-body">
                    <div class="demo-progress-instruction" id="demoInstruction">
                        Cette démonstration vous apprend à parcourir les catégories de la bibliothèque d'images, puis à sélectionner et appliquer un fond d'écran ainsi qu'un fond de bulle.
                    </div>
                    
                    <div class="demo-progress-bar-container">
                        <div class="demo-progress-bar" id="progressBar"></div>
                    </div>
                    
                    <div class="demo-progress-controls">
                        <button class="demo-button secondary" id="prevStepBtn" disabled>Étape précédente</button>
                        <button class="demo-button" id="startDemo">Démarrer</button>
                        <button class="demo-button secondary" id="stopDemo" disabled>Arrêter</button>
                        <button class="demo-button secondary" id="closeDemo">Fermer</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Disposition en trois colonnes -->
        <div class="demo-layout">
            <!-- Panneau gauche : Bibliothèque -->
            <div class="demo-left-panel">
                <div class="main-container" id="libraryWindow">
            <div class="main-border">
            <div class="content-grid">
                <!-- En-tête -->
                <div class="header">
                    <div class="title">Bibliothèque d'Images</div>
                    <button class="close-button" onclick="closeWindow()">✕</button>
                </div>

                <!-- Contenu principal -->
                <div class="main-content">
                    <!-- Volet des catégories -->
                    <div class="categories-panel">
                        <div class="categories-title">Catégories</div>
                        <div class="categories-list" id="categoriesList">
                            <button class="category-button selected" data-category="3d">3D</button>
                            <button class="category-button" data-category="abstract">Abstract</button>
                            <button class="category-button" data-category="bricks">Bricks</button>
                            <button class="category-button" data-category="floral">Floral</button>
                            <button class="category-button" data-category="forest">Forest</button>
                            <button class="category-button" data-category="fruity">Fruity</button>
                            <button class="category-button" data-category="landscape">Landscape</button>
                            <button class="category-button" data-category="nature">Nature</button>
                            <button class="category-button" data-category="sea">Sea</button>
                            <button class="category-button" data-category="village">Village</button>
                            <button class="category-button" data-category="marble">Marble</button>
                            <button class="category-button" data-category="stone">Stone</button>
                        </div>
                    </div>

                    <!-- Séparateur -->
                    <div class="splitter"></div>

                    <!-- Zone des images -->
                    <div class="images-panel">
                        <div class="current-category-title" id="currentCategoryTitle">3D</div>
                        <div class="images-container">
                            <div class="images-grid" id="imagesGrid">
                                <!-- Les images seront générées par JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Barre d'état -->
                <div class="status-bar">
                    <div class="status-text" id="statusText">3D - 12 image(s)</div>
                    <div class="action-buttons">
                        <button class="action-button" id="applyWallpaperBtn" disabled>Appliquer comme fond d'écran</button>
                        <button class="action-button primary" id="selectBtn" disabled>Sélectionner</button>
                        <button class="action-button" id="cancelBtn">Annuler</button>
                    </div>
                </div>
            </div>
        </div>
        </div>
            </div>

            <!-- Panneau droit : Bulle de démonstration -->
            <div class="demo-right-panel">
                <div class="demo-bubble-container">
                    <div class="demo-bubble-border">
                        <!-- En-tête -->
                        <div class="demo-bubble-header">
                            <div class="demo-bubble-title">Bureau</div>
                        </div>

                        <!-- Contenu principal -->
                        <div class="demo-bubble-content">
                            <div class="demo-bubble-canvas">
                                <!-- Bordure dynamique (bulle) -->
                                <div class="dynamic-border" id="demoBubble"></div>

                                <!-- Étiquette centrée automatiquement -->
                                <div class="label-border">
                                    <div class="label-text" id="bubbleLabelText">Ma Bulle</div>
                                </div>

                                <!-- Poignée de redimensionnement -->
                                <div class="resize-handle"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panneau messages (colonne droite) -->
            <div class="demo-messages-panel">
                <!-- Zone des messages explicatifs -->
                <div id="messagesContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales pour la démonstration
        let demoRunning = false;
        let currentStep = 0;
        let categoryAnimationActive = false;
        let navigationAnimationActive = false;
        let demoSteps = [
            "Cliquez sur une catégorie dans la liste de gauche",
            "Explorez les différentes catégories disponibles",
            "Sélectionnez une image pour voir les options"
        ];

        // Données de démonstration avec 12 catégories (3D à Stone)
        const categories = {
            '3d': { name: '3D', count: 24, colors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9', '#F8C471', '#82E0AA', '#F1948A', '#85C1E9', '#D7BDE2', '#A9DFBF', '#F9E79F', '#AED6F1', '#D5DBDB', '#FADBD8', '#D1F2EB', '#FCF3CF', '#E8DAEF', '#D5DBDB'] },
            'abstract': { name: 'Abstract', count: 18, colors: ['#E74C3C', '#9B59B6', '#3498DB', '#1ABC9C', '#F39C12', '#E67E22', '#95A5A6', '#34495E', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#00BCD4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39'] },
            'bricks': { name: 'Bricks', count: 15, colors: ['#8B4513', '#A0522D', '#CD853F', '#D2691E', '#B22222', '#DC143C', '#B8860B', '#DAA520', '#CD853F', '#DEB887', '#F4A460', '#D2B48C', '#BC8F8F', '#F0E68C', '#DDA0DD'] },
            'floral': { name: 'Floral', count: 22, colors: ['#FF69B4', '#FF1493', '#FFB6C1', '#FFC0CB', '#DDA0DD', '#DA70D6', '#BA55D3', '#9370DB', '#8A2BE2', '#9400D3', '#9932CC', '#8B008B', '#800080', '#4B0082', '#6A5ACD', '#7B68EE', '#9370DB', '#8A2BE2', '#9400D3', '#9932CC', '#8B008B', '#800080'] },
            'forest': { name: 'Forest', count: 20, colors: ['#228B22', '#32CD32', '#00FF00', '#7CFC00', '#ADFF2F', '#9ACD32', '#6B8E23', '#556B2F', '#2E8B57', '#3CB371', '#20B2AA', '#48D1CC', '#40E0D0', '#00CED1', '#5F9EA0', '#4682B4', '#6495ED', '#7B68EE', '#9370DB', '#8A2BE2'] },
            'fruity': { name: 'Fruity', count: 16, colors: ['#FF4500', '#FF6347', '#FF7F50', '#FFA500', '#FFD700', '#FFFF00', '#ADFF2F', '#7FFF00', '#00FF7F', '#00FA9A', '#40E0D0', '#00CED1', '#1E90FF', '#4169E1', '#0000FF', '#8A2BE2'] },
            'landscape': { name: 'Landscape', count: 25, colors: ['#87CEEB', '#B0E0E6', '#ADD8E6', '#87CEFA', '#00BFFF', '#1E90FF', '#4169E1', '#0000FF', '#0000CD', '#00008B', '#191970', '#483D8B', '#6A5ACD', '#7B68EE', '#9370DB', '#8A2BE2', '#9400D3', '#9932CC', '#8B008B', '#800080', '#4B0082', '#2F4F4F', '#708090', '#778899', '#B0C4DE'] },
            'nature': { name: 'Nature', count: 28, colors: ['#90EE90', '#98FB98', '#8FBC8F', '#9ACD32', '#ADFF2F', '#7FFF00', '#7CFC00', '#00FF00', '#32CD32', '#00FA9A', '#00FF7F', '#3CB371', '#2E8B57', '#228B22', '#006400', '#556B2F', '#6B8E23', '#808000', '#BDB76B', '#F0E68C', '#EEE8AA', '#F5DEB3', '#DEB887', '#D2B48C', '#BC8F8F', '#F4A460', '#D2691E', '#CD853F'] },
            'sea': { name: 'Sea', count: 19, colors: ['#4169E1', '#0000FF', '#0000CD', '#00008B', '#191970', '#483D8B', '#6A5ACD', '#7B68EE', '#9370DB', '#8A2BE2', '#9400D3', '#9932CC', '#8B008B', '#800080', '#4B0082', '#2F4F4F', '#708090', '#778899', '#B0C4DE'] },
            'village': { name: 'Village', count: 14, colors: ['#8B4513', '#A0522D', '#CD853F', '#D2691E', '#B22222', '#DC143C', '#B8860B', '#DAA520', '#CD853F', '#DEB887', '#F4A460', '#D2B48C', '#BC8F8F', '#F0E68C'] },
            'marble': { name: 'Marble', count: 12, colors: ['#F5F5DC', '#FFFAF0', '#FDF5E6', '#FAF0E6', '#F5DEB3', '#DEB887', '#D2B48C', '#BC8F8F', '#F4A460', '#D2691E', '#CD853F', '#A0522D'] },
            'stone': { name: 'Stone', count: 17, colors: ['#A9A9A9', '#C0C0C0', '#D3D3D3', '#DCDCDC', '#F5F5F5', '#696969', '#808080', '#778899', '#708090', '#2F4F4F', '#483D8B', '#6A5ACD', '#7B68EE', '#9370DB', '#8A2BE2', '#9400D3', '#9932CC'] }
        };

        let currentCategory = '3d';
        let selectedImageIndex = -1;
        let selectedImageColor = null;
        let userSelectedCategories = [];

        // Fonction pour générer une image SVG avec une couleur spécifique
        function generateColoredImage(color, index) {
            const svg = `
                <svg width="80" height="60" viewBox="0 0 80 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="80" height="60" fill="#F0F0F0" stroke="#CCCCCC"/>
                    <svg x="3" y="3" width="74" height="54" viewBox="0 0 74 54">
                        <rect width="74" height="54" fill="${color}"/>
                        <svg x="25" y="15" width="24" height="24" viewBox="0 -960 960 960" fill="#e3e3e3">
                            <path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm40-80h480L570-480 450-320l-90-120-120 160Zm-40 80v-560 560Z"/>
                        </svg>
                    </svg>
                </svg>
            `;
            return 'data:image/svg+xml;base64,' + btoa(svg);
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            initializeCategories();
            loadImagesForCategory(currentCategory);
        });

        function setupEventListeners() {
            document.getElementById('startDemo').addEventListener('click', startDemo);
            document.getElementById('stopDemo').addEventListener('click', stopDemo);
            document.getElementById('closeDemo').addEventListener('click', closeDemo);
            const prevBtn = document.getElementById('prevStepBtn');
            if (prevBtn) prevBtn.addEventListener('click', goToPreviousStep);
        }

        function startDemo() {
            if (demoRunning) return;
            
            demoRunning = true;
            currentStep = 0;
            
            // Mettre à jour les boutons
            document.getElementById('startDemo').disabled = true;
            document.getElementById('stopDemo').disabled = false;
            document.getElementById('prevStepBtn').disabled = true;
            
            // Commencer la démonstration avec un message et un bouton Ok pour continuer
            setTimeout(() => {
                showStructuredMessage("🎯 Démonstration démarrée", [
                    {
                        type: 'info',
                        icon: '📖',
                        title: 'Bienvenue',
                        content: "Nous allons explorer les catégories disponibles dans la bibliothèque d'images. Regardez les éléments mis en surbrillance !"
                    }
                ], 'continueFromStartMessage()');
            }, 300);
        }

        function stopDemo() {
            demoRunning = false;
            completeDemo();
        }

        function resetDemo() {
            demoRunning = false;
            currentStep = 0;
            
            // Arrêter toutes les animations
            categoryAnimationActive = false;
            navigationAnimationActive = false;
            
            // Réinitialiser les boutons
            document.getElementById('startDemo').disabled = false;
            document.getElementById('stopDemo').disabled = true;
            document.getElementById('prevStepBtn').disabled = true;
            
            // Réinitialiser la progression
            updateProgress(0);
            updateInstruction("Cette démonstration va vous montrer comment explorer les différentes catégories disponibles dans la bibliothèque d'images.");
            
            // Réinitialiser la sélection
            document.querySelectorAll('.category-button').forEach(btn => {
                btn.classList.remove('selected', 'demo-highlight');
            });
            document.querySelector('[data-category="3d"]').classList.add('selected');
            currentCategory = '3d';
            selectedImageIndex = -1;
            selectedImageColor = null;
            userSelectedCategories = [];
            loadImagesForCategory('3d');
            
            // Réinitialiser la bulle de démonstration
            resetDemoBubble();
            
            // Fermer tous les messages
            closeAllMessages();
            
            // Réinitialiser le fond d'écran
            document.body.style.backgroundColor = '';
        }

        function closeDemo() {
            // Réinitialiser le fond d'écran avant de fermer
            document.body.style.backgroundColor = '';
            
            // Réinitialiser le fond du canvas
            const demoCanvas = document.querySelector('.demo-bubble-canvas');
            if (demoCanvas) {
                demoCanvas.style.backgroundColor = '#2D2D2D';
            }
            
            window.close();
        }

        function highlightCategories() {
            updateInstruction("Étape 1 : Voici la liste des catégories disponibles. Cliquez sur une catégorie pour l'explorer.");
            
            showStructuredMessage("📚 Étape 1 : Découverte des catégories", [
                {
                    type: 'info',
                    icon: '📖',
                    title: 'Explication',
                    content: '- La bibliotheque est organisée en plusieurs catégories affichées par ordre alphabetique dans le volet de gauche.<br>- Chaque catégorie est thématisée et contient des images spécifiques.<br>- Les images de chaque catégorie sont spécifiquement crées pour s\'afficher correctement comme fond de Bulle ou comme fond d\'écran.'
                }
            ], 'validateStep1()');
            
            // Démarrer la boucle d'animation
            startCategoryAnimationLoop();
        }

        function startCategoryAnimationLoop() {
            categoryAnimationActive = true;

            // Mettre en surbrillance simplement et statiquement les 10 premières catégories
            const categoryButtons = document.querySelectorAll('.category-button');
            const firstTwelveCategories = Array.from(categoryButtons).slice(0, 12);
            firstTwelveCategories.forEach(btn => btn.classList.add('demo-highlight-orange'));
        }

        function showCategoryExploration() {
            updateInstruction("Étape 2 : 🎯 ACTION REQUISE - Cliquez, dans l'ordre, sur les 3 premières catégories.");
            
            // Réinitialiser les sélections de l'utilisateur
            userSelectedCategories = [];
            
            // Afficher le message explicatif
            showStructuredMessage("🔄 Étape 2 : Navigation entre catégories", [
                {
                    type: 'info',
                    icon: '📖',
                    title: 'Explication',
                    content: 'Cliquez sur les onglets de catégories pour afficher les images correspondantes. Chaque catégorie regroupe des images par thème.'
                },
                {
                    type: 'action',
                    icon: '🎯',
                    title: 'ACTION REQUISE',
                    content: 'Cliquez sur la catégorie qui clignote dans le volet de gauche.\nVeuillez cliquer sur 3 catégorie pour valider l\'étape.'
                },
                {
                    type: 'tip',
                    icon: '💡',
                    title: '💡 Progression',
                    content: 'Catégories sélectionnées : 0/3'
                }
            ]);
            
            // Démarrer le guidage séquentiel (3 premières catégories)
            startSequentialCategoryGuidance();
        }

        function startSequentialCategoryGuidance() {
            const guidedCategories = ['abstract', 'bricks', 'floral'];
            let guidedIndex = 0;
            const categoryButtons = document.querySelectorAll('.category-button');

            const highlightCurrent = () => {
                // Retirer tout highlight existant
                categoryButtons.forEach(btn => {
                    btn.classList.remove('demo-highlight');
                    btn.classList.remove('demo-highlight-orange');
                });
                // Mettre en évidence uniquement la catégorie courante
                const currentId = guidedCategories[guidedIndex];
                const currentBtn = document.querySelector(`.category-button[data-category="${currentId}"]`);
                if (currentBtn) currentBtn.classList.add('demo-highlight-orange');
            };

            const onCategoryClick = (e) => {
                const clickedId = e.currentTarget.dataset.category;
                const expectedId = guidedCategories[guidedIndex];
                if (clickedId !== expectedId) {
                    return; // Ignorer les clics hors séquence
                }

                // Enregistrer et appliquer la sélection
                userSelectedCategories.push(clickedId);
                selectCategory(clickedId);
                updateCategoryProgressMessage();

                // Avancer ou valider
                guidedIndex++;
                if (guidedIndex >= guidedCategories.length) {
                    // Retirer tout highlight et terminer l'étape
                    categoryButtons.forEach(btn => {
                        btn.classList.remove('demo-highlight');
                        btn.classList.remove('demo-highlight-orange');
                    });
                    validateStep2();
                    // Nettoyer les écouteurs
                    categoryButtons.forEach(btn => btn.removeEventListener('click', onCategoryClick));
                } else {
                    highlightCurrent();
                }
            };

            // Attacher les écouteurs
            categoryButtons.forEach(btn => btn.addEventListener('click', onCategoryClick));
            // Initialiser le premier highlight
            highlightCurrent();
        }

        function updateCategoryProgressMessage() {
            // Mettre à jour le message avec la progression actuelle
            const messageContainer = document.querySelector('.demo-message');
            if (messageContainer) {
                const progressSection = messageContainer.querySelector('.tip-section .section-content');
                if (progressSection) {
                    progressSection.textContent = `Catégories sélectionnées : ${userSelectedCategories.length}/3`;
                }
            }
        }


        function showImageSelection() {
            updateInstruction("Étape 3 : 🎯 ACTION REQUISE - Cliquez sur n'importe quelle image pour la sélectionner et voir les options disponibles.");
            currentStep = 2;
            const prevBtn = document.getElementById('prevStepBtn');
            if (prevBtn) prevBtn.disabled = false;
            
            // Mettre en surbrillance toutes les images et attendre le clic utilisateur
            setTimeout(() => {
                const allImages = document.querySelectorAll('.image-button');
                const imagesGrid = document.querySelector('.images-grid');
                if (allImages.length > 0 && imagesGrid) {
                    showStructuredMessage("✨ Étape 3 : Sélection d'image", [
                        {
                            type: 'info',
                            icon: '📖',
                            title: 'Explication',
                            content: 'Maintenant, nous allons voir comment sélectionner une image et utiliser les options disponibles.'
                        },
                        {
                            type: 'action',
                            icon: '🎯',
                            title: 'ACTION REQUISE',
                            content: 'Cliquez sur n\'importe quelle image pour la sélectionner. Les boutons \'Sélectionner\' et \'Appliquer comme fond\' deviendront alors actifs.'
                        },
                        {
                            type: 'tip',
                            icon: '💡',
                            title: 'Conseil',
                            content: 'Toutes les images clignotent pour vous montrer qu\'elles sont sélectionnables !'
                        }
                    ]);
                    
                    // Mettre en surbrillance toutes les images
                    allImages.forEach(img => {
                        img.classList.add('demo-highlight');
                    });
                    
                    // Écoute déléguée pour permettre la sélection même si la catégorie change
                    const delegatedClickHandler = (event) => {
                        const targetButton = event.target.closest('.image-button');
                        if (!targetButton) return;

                        document.querySelectorAll('.image-button').forEach(img => {
                            img.classList.remove('demo-highlight');
                        });

                        updateProgress(75); // Étape 3 atteinte
                        closeAllMessages();
                        showButtonExplanations();

                        imagesGrid.removeEventListener('click', delegatedClickHandler);
                    };

                    imagesGrid.addEventListener('click', delegatedClickHandler);
                }
            }, 1000);
        }

        function showButtonExplanations() {
            updateInstruction("Étape 4 : 🎯 ACTION REQUISE - Cliquez sur le bouton 'Appliquer comme fond d'écran' mis en surbrillance pour l'essayer !");
            currentStep = 3;
            const prevBtn = document.getElementById('prevStepBtn');
            if (prevBtn) prevBtn.disabled = false;
            
            // Mettre en surbrillance le bouton AVANT d'afficher le message
            highlightButton('applyWallpaperBtn', 'applyWallpaperHighlight');
            
            // Attendre un peu puis afficher le message
            setTimeout(() => {
                showStructuredMessage("🔘 Étape 4 : Bouton 'Appliquer comme fond d'écran'", [
                    {
                        type: 'info',
                        icon: '📖',
                        title: 'Fonction du bouton',
                        content: 'Applique l\'image sélectionnée comme fond d\'écran immédiatement.'
                    },
                    {
                        type: 'tip',
                        icon: '💡',
                        title: 'Conseil',
                        content: 'Permet d\'appliquer rapidement différentes images comme fond d\'écran et de voir immédiatement le résultat.'
                    },
                    {
                        type: 'action',
                        icon: '🎯',
                        title: 'ACTION REQUISE',
                        content: 'Cliquez sur le bouton \'Appliquer comme fond d\'écran\' mis en surbrillance pour l\'essayer !'
                    },
                    {
                        type: 'tip',
                        icon: '👀',
                        title: 'Indication visuelle',
                        content: 'Le bouton clignote pour attirer votre attention !'
                    }
                ]);
                
                // Ajouter un event listener pour détecter le clic utilisateur
                const applyWallpaperBtn = document.getElementById('applyWallpaperBtn');
                if (applyWallpaperBtn) {
                    const handleWallpaperClick = () => {
                        // Appliquer la couleur de l'image sélectionnée au fond du canvas de démonstration
                        const demoCanvas = document.querySelector('.demo-bubble-canvas');
                        if (demoCanvas) {
                            demoCanvas.style.backgroundColor = selectedImageColor || '#0078d4';
                        }
                        
                        // Supprimer la surbrillance
                        hideHighlight('applyWallpaperHighlight');
                        
                        // Étape 4 atteinte
                        updateProgress(85);
                        
                        // Fermer le message et passer à l'étape suivante (sélection image pour bulle)
                        closeAllMessages();
                        showBubbleImagePick();
                        
                        // Supprimer l'event listener après utilisation
                        applyWallpaperBtn.removeEventListener('click', handleWallpaperClick);
                    };
                    
                    applyWallpaperBtn.addEventListener('click', handleWallpaperClick);
                }
            }, 500);
        }

        function showBubbleImagePick() {
            updateInstruction("Étape 5 : 🎯 ACTION REQUISE - Sélectionnez une nouvelle image pour le fond de bulle.");
            currentStep = 4;
            const prevBtn = document.getElementById('prevStepBtn');
            if (prevBtn) prevBtn.disabled = false;

            setTimeout(() => {
                const allImages = document.querySelectorAll('.image-button');
                const imagesGrid = document.querySelector('.images-grid');
                if (allImages.length > 0 && imagesGrid) {
                    showStructuredMessage("🖼️ Étape 5 : Sélection d'une image (fond de bulle)", [
                        {
                            type: 'info',
                            icon: '📖',
                            title: 'Explication',
                            content: 'Choisissez une image (de préférence différente de celle de l\'étape 3) qui servira de fond pour la bulle.'
                        },
                        {
                            type: 'action',
                            icon: '🎯',
                            title: 'ACTION REQUISE',
                            content: 'Cliquez sur une image pour la sélectionner. Nous l\'appliquerons à la bulle à l\'étape suivante.'
                        }
                    ]);

                    allImages.forEach(img => img.classList.add('demo-highlight'));

                    const delegatedClickHandler = (event) => {
                        const targetButton = event.target.closest('.image-button');
                        if (!targetButton) return;

                        document.querySelectorAll('.image-button').forEach(img => img.classList.remove('demo-highlight'));
                        updateProgress(95);
                        closeAllMessages();
                        showBubbleSelectButtonExplanation();

                        imagesGrid.removeEventListener('click', delegatedClickHandler);
                    };

                    imagesGrid.addEventListener('click', delegatedClickHandler);
                }
            }, 600);
        }

        function showBubbleSelectButtonExplanation() {
            updateInstruction("Étape 6 : 🎯 ACTION REQUISE - Cliquez sur le bouton 'Sélectionner' pour appliquer l'image à la bulle.");
            currentStep = 5;
            const prevBtn = document.getElementById('prevStepBtn');
            if (prevBtn) prevBtn.disabled = false;

            showStructuredMessage("🎯 Étape 6 : Bouton 'Sélectionner' (fond de bulle)", [
                {
                    type: 'info',
                    icon: '📖',
                    title: 'Fonction du bouton',
                    content: 'Applique l\'image sélectionnée comme fond de bulle.'
                },
                {
                    type: 'tip',
                    icon: '💡',
                    title: 'Différence avec le fond d\'écran',
                    content: 'Le bouton "Sélectionner" applique l\'image uniquement à la bulle, pas au fond d\'écran.'
                },
                {
                    type: 'action',
                    icon: '🎯',
                    title: 'ACTION REQUISE',
                    content: 'Cliquez sur le bouton "Sélectionner" pour appliquer l\'image à la bulle.'
                }
            ]);

            highlightButton('selectBtn', 'selectBtnHighlight');

            const selectBtn = document.getElementById('selectBtn');
            if (selectBtn) {
                const handleSelectClick = () => {
                    const categoryData = categories[currentCategory];
                    const selectedColor = categoryData.colors[selectedImageIndex];
                    updateDemoBubble(categoryData.name, selectedColor);
                    hideHighlight('selectBtnHighlight');
                    updateProgress(95);
                    closeAllMessages();
                    showFinalMessage();
                    selectBtn.removeEventListener('click', handleSelectClick);
                };
                selectBtn.addEventListener('click', handleSelectClick);
            }
        }

        function showSelectButtonExplanation() {
            updateInstruction("Étape 5 : 🎯 ACTION REQUISE - Sélectionnez une nouvelle image puis cliquez sur 'Sélectionner' pour l'appliquer à la bulle.");
            currentStep = 4;
            const prevBtn = document.getElementById('prevStepBtn');
            if (prevBtn) prevBtn.disabled = false;
            
            // Mettre en surbrillance toutes les images et attendre le clic utilisateur
            setTimeout(() => {
                const allImages = document.querySelectorAll('.image-button');
                if (allImages.length > 0) {
                    showStructuredMessage("🎯 Étape 5 : Bouton 'Sélectionner'", [
                        {
                            type: 'info',
                            icon: '📖',
                            title: 'Fonction du bouton',
                            content: 'Applique l\'image sélectionnée comme fond de bulle.'
                        },
                        {
                            type: 'tip',
                            icon: '💡',
                            title: 'Différence avec le bouton précédent',
                            content: 'Contrairement au bouton "Appliquer comme fond d\'écran", celui-ci applique l\'image uniquement comme fond de la bulle sélectionnée.'
                        },
                        {
                            type: 'action',
                            icon: '🎯',
                            title: 'ACTION REQUISE',
                            content: 'Sélectionnez une nouvelle image (différente de celle de l\'étape 3) puis cliquez sur le bouton "Sélectionner" pour l\'appliquer à la bulle.'
                        }
                    ]);
                    
                    // Mettre en surbrillance toutes les images
                    allImages.forEach(img => {
                        img.classList.add('demo-highlight');
                    });
                    
                    // Ajouter un event listener pour détecter le clic utilisateur sur n'importe quelle image
                    const handleImageClick = (event) => {
                        // Retirer la surbrillance de toutes les images
                        allImages.forEach(img => {
                            img.classList.remove('demo-highlight');
                        });
                        
                        // Mettre en surbrillance le bouton "Sélectionner"
                        highlightButton('selectBtn', 'selectBtnHighlight');
                        
                        // Ajouter un event listener pour le bouton "Sélectionner"
                        const selectBtn = document.getElementById('selectBtn');
                        if (selectBtn) {
                            const handleSelectClick = () => {
                                // Appliquer la couleur de l'image sélectionnée à la bulle
                                const categoryData = categories[currentCategory];
                                const selectedColor = categoryData.colors[selectedImageIndex];
                                updateDemoBubble(categoryData.name, selectedColor);
                                
                                // Supprimer la surbrillance
                                hideHighlight('selectBtnHighlight');
                                
                                // Atteindre 95% à la fin de l'étape 5
                                updateProgress(95);
                                
                                // Fermer le message et passer à l'étape suivante
                                closeAllMessages();
                                showFinalMessage();
                                
                                // Supprimer l'event listener après utilisation
                                selectBtn.removeEventListener('click', handleSelectClick);
                            };
                            
                            selectBtn.addEventListener('click', handleSelectClick);
                        }
                        
                        // Supprimer l'event listener après utilisation
                        allImages.forEach(img => {
                            img.removeEventListener('click', handleImageClick);
                        });
                    };
                    
                    allImages.forEach(img => {
                        img.addEventListener('click', handleImageClick);
                    });
                }
            }, 1000);
        }

        function showFinalMessage() {
            updateInstruction("Étape 6 : Démonstration terminée !");
            // Forcer la progression à 100% à l'étape finale
            updateProgress(100);
            const prevBtn = document.getElementById('prevStepBtn');
            if (prevBtn) prevBtn.disabled = true;
            showStructuredMessage("🎉 Étape 6 : Démonstration terminée !", [
                {
                    type: 'info',
                    icon: '✅',
                    title: 'Félicitations !',
                    content: 'Vous avez maintenant une compréhension complète des catégories disponibles dans la bibliothèque d\'images et de la différence entre les deux boutons d\'action.'
                },
                {
                    type: 'tip',
                    icon: '💡',
                    title: 'Récapitulatif',
                    content: 'Vous savez maintenant : naviguer entre les catégories, sélectionner une image, appliquer un fond d\'écran, et appliquer un fond de bulle.'
                },
                {
                    type: 'info',
                    icon: '🎯',
                    title: 'Démonstration terminée !',
                    content: 'Vous avez maintenant exploré les catégories disponibles dans la bibliothèque d\'images. Vous pouvez naviguer entre les différentes catégories et sélectionner des images pour vos bulles.'
                }
            ], 'completeDemo()');
            
            // Réinitialiser le fond d'écran à la fin de la démonstration
            document.body.style.backgroundColor = '';
        }


        function updateInstruction(text) {
            document.getElementById('demoInstruction').textContent = text;
        }

        function updateProgress(percentage) {
            const bar = document.getElementById('progressBar');
            bar.style.width = percentage + '%';
            if (percentage >= 100) {
                bar.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
            } else {
                bar.style.background = 'linear-gradient(90deg, #0078d4, #106ebe)';
            }
        }

        function showMessage(title, content) {
            // Fermer les messages existants
            closeAllMessages();
            
            const message = document.createElement('div');
            message.className = 'demo-message';
            message.innerHTML = `
                <button class="close-btn" onclick="closeMessage(this)">×</button>
                <h4>${title}</h4>
                <p>${content}</p>
            `;
            
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.appendChild(message);
            
            // Afficher avec animation
            setTimeout(() => {
                message.classList.add('show');
            }, 100);
            
            // Plus d'auto-fermeture: attend une action utilisateur
        }

        function showStructuredMessage(title, sections, validationCallback = null) {
            // Fermer les messages existants
            closeAllMessages();
            
            const message = document.createElement('div');
            message.className = 'demo-message';
            
            let sectionsHTML = '';
            sections.forEach(section => {
                const sectionClass = section.type === 'action' ? 'action-required' : 
                                   section.type === 'tip' ? 'tip-section' : '';
                sectionsHTML += `
                    <div class="message-section ${sectionClass}">
                        <div class="section-title">${section.icon} ${section.title}</div>
                        <div class="section-content">${section.content}</div>
                    </div>
                `;
            });
            
            let validationButtonHTML = '';
            if (validationCallback) {
                validationButtonHTML = `
                    <button class="validation-button" onclick="${validationCallback}">
                        ✓ Valider cette étape
                    </button>
                `;
            }
            
            message.innerHTML = `
                <button class="close-btn" onclick="closeMessage(this)">×</button>
                <div class="message-title">${title}</div>
                ${sectionsHTML}
                ${validationButtonHTML}
            `;
            
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.appendChild(message);
            
            // Afficher avec animation
            setTimeout(() => {
                message.classList.add('show');
            }, 100);
            
            // Auto-fermer après 10 secondes si pas de bouton de validation ET pas d'action requise
            // Désactivation de l'auto-fermeture pour laisser l'utilisateur décider quand continuer
            // Les messages avec boutons de validation ou actions requises ne se ferment pas automatiquement
        }

        function continueFromStartMessage() {
            closeAllMessages();
            highlightCategories();
        }

        function closeMessage(closeBtn) {
            const message = closeBtn.closest('.demo-message');
            if (message) {
                message.classList.remove('show');
                setTimeout(() => {
                    if (message.parentNode) {
                        message.parentNode.removeChild(message);
                    }
                }, 500);
            }
        }

        function closeAllMessages() {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '';
        }

        // Fonctions de validation pour chaque étape
        function validateStep1() {
            categoryAnimationActive = false; // Arrêter l'animation des catégories
            
            // Supprimer tous les effets d'animation des catégories
            document.querySelectorAll('.category-button').forEach(btn => {
                btn.classList.remove('demo-highlight');
            });
            
            updateProgress(33); // Atteindre 33% à la validation de l'étape 1
            closeAllMessages();
            showCategoryExploration();
            currentStep = 1;
            document.getElementById('prevStepBtn').disabled = false;
        }

        function validateStep2() {
            updateProgress(66); // Atteindre 66% à la validation de l'étape 2
            closeAllMessages();
            showImageSelection();
            currentStep = 2;
            document.getElementById('prevStepBtn').disabled = false;
        }

        function validateStep3() {
            closeAllMessages();
            showButtonExplanations();
            currentStep = 3;
            document.getElementById('prevStepBtn').disabled = false;
        }

        function validateStep4() {
            closeAllMessages();
            showBubbleImagePick();
            currentStep = 4;
            document.getElementById('prevStepBtn').disabled = false;
        }

        function validateStep5() {
            updateProgress(100); // Atteindre 100% à la validation de l'étape 5
            closeAllMessages();
            showFinalMessage();
            currentStep = 5;
            document.getElementById('prevStepBtn').disabled = false;
        }

        function goToPreviousStep() {
            if (!demoRunning) return;
            if (currentStep <= 0) return;
            // Arrêter toutes les animations et effets visuels
            stopAllEffects();
            closeAllMessages();
            switch (currentStep) {
                case 1:
                    // Revenir à l'étape 1
                    updateProgress(0);
                    document.getElementById('prevStepBtn').disabled = true;
                    highlightCategories();
                    currentStep = 0;
                    break;
                case 2:
                    // Revenir à l'étape 2
                    updateProgress(33);
                    showCategoryExploration();
                    currentStep = 1;
                    document.getElementById('prevStepBtn').disabled = false;
                    break;
                case 3:
                    // Revenir à l'étape 2
                    updateProgress(66);
                    showImageSelection();
                    currentStep = 2;
                    document.getElementById('prevStepBtn').disabled = false;
                    break;
                case 4:
                    // Revenir à l'étape 3
                    updateProgress(75);
                    showButtonExplanations();
                    currentStep = 3;
                    document.getElementById('prevStepBtn').disabled = false;
                    break;
                case 5:
                    // Revenir à l'étape 4
                    updateProgress(75);
                    showButtonExplanations();
                    currentStep = 3;
                    document.getElementById('prevStepBtn').disabled = false;
                    break;
                default:
                    break;
            }
        }

        function stopAllEffects() {
            // Flags d'animation
            categoryAnimationActive = false;
            navigationAnimationActive = false;

            // Nettoyer surbrillances des catégories
            document.querySelectorAll('.category-button').forEach(btn => {
                btn.classList.remove('demo-highlight');
                btn.classList.remove('demo-highlight-orange');
            });

            // Nettoyer surbrillances des images
            document.querySelectorAll('.image-button').forEach(btn => {
                btn.classList.remove('demo-highlight');
                btn.classList.remove('selected');
            });

            // Supprimer les overlays de mise en évidence de boutons
            document.querySelectorAll('.button-highlight').forEach(el => el.remove());

            // Retirer les écouteurs spécifiques ajoutés pendant les étapes en remplaçant les nœuds (catégories et images)
            const categoriesList = document.querySelectorAll('.category-button');
            categoriesList.forEach(btn => {
                const clone = btn.cloneNode(true);
                btn.parentNode.replaceChild(clone, btn);
            });

            const imagesList = document.querySelectorAll('.image-button');
            imagesList.forEach(btn => {
                const clone = btn.cloneNode(true);
                btn.parentNode.replaceChild(clone, btn);
            });

            // Réattacher les écouteurs de base
            initializeCategories();
        }

        function completeDemo() {
            // Fermer la démonstration
            demoRunning = false;

            // Nettoyer effets et messages
            stopAllEffects();
            closeAllMessages();

            // Réinitialiser instruction et progression
            updateInstruction("Cette démonstration va vous montrer comment explorer les différentes catégories disponibles dans la bibliothèque d'images.");
            updateProgress(0);

            // Réinitialiser sélection catégories et images
            document.querySelectorAll('.category-button').forEach(btn => {
                btn.classList.remove('selected', 'demo-highlight');
            });
            const firstCategoryBtn = document.querySelector('[data-category="3d"]');
            if (firstCategoryBtn) firstCategoryBtn.classList.add('selected');
            currentCategory = '3d';
            selectedImageIndex = -1;
            selectedImageColor = null;
            userSelectedCategories = [];
            loadImagesForCategory('3d');

            // Réinitialiser la bulle et le fond d'écran de la démo
            resetDemoBubble();
            const demoCanvas = document.querySelector('.demo-bubble-canvas');
            if (demoCanvas) demoCanvas.style.backgroundColor = '#2D2D2D';

            // Réinitialiser boutons
            const prevBtn = document.getElementById('prevStepBtn');
            if (prevBtn) prevBtn.disabled = true;
            document.getElementById('startDemo').disabled = false;
            document.getElementById('stopDemo').disabled = true;
        }

        function highlightButton(buttonId, highlightId) {
            const button = document.getElementById(buttonId);
            if (button) {
                const rect = button.getBoundingClientRect();
                
                const highlight = document.createElement('div');
                highlight.className = 'button-highlight';
                highlight.id = highlightId;
                highlight.style.position = 'fixed';
                highlight.style.left = (rect.left - 3) + 'px';
                highlight.style.top = (rect.top - 3) + 'px';
                highlight.style.width = (rect.width + 6) + 'px';
                highlight.style.height = (rect.height + 6) + 'px';
                highlight.style.zIndex = '999';
                highlight.style.pointerEvents = 'none';
                
                document.body.appendChild(highlight);
                
                // Simuler un clic visuel
                button.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    button.style.transform = 'scale(1)';
                }, 150);
            }
        }

        function hideHighlight(highlightId) {
            const highlight = document.getElementById(highlightId);
            if (highlight) {
                highlight.remove();
            }
        }

        function initializeCategories() {
            const categoryButtons = document.querySelectorAll('.category-button');
            categoryButtons.forEach(button => {
                button.addEventListener('click', function() {
                    if (!demoRunning) return; // Empêcher les clics pendant la démonstration
                    const category = this.dataset.category;
                    selectCategory(category);
                });
            });
        }

        function selectCategory(category) {
            // Mettre à jour la sélection visuelle
            document.querySelectorAll('.category-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('selected');

            // Charger les images pour cette catégorie
            currentCategory = category;
            loadImagesForCategory(category);
        }

        function loadImagesForCategory(category) {
            const categoryData = categories[category];
            const imagesGrid = document.getElementById('imagesGrid');
            const categoryTitle = document.getElementById('currentCategoryTitle');
            const statusText = document.getElementById('statusText');

            // Mettre à jour le titre
            categoryTitle.textContent = categoryData.name;

            // Générer les images avec des couleurs cohérentes par catégorie
            imagesGrid.innerHTML = '';
            for (let i = 0; i < categoryData.count; i++) {
                const imageButton = document.createElement('button');
                imageButton.className = 'image-button';
                const coloredImage = generateColoredImage(categoryData.colors[i], i);
                imageButton.innerHTML = `<img src="${coloredImage}" alt="Image ${i + 1}">`;
                imageButton.addEventListener('click', function() {
                    if (!demoRunning) return; // Empêcher les clics pendant la démonstration
                    selectImage(i, this);
                });
                imagesGrid.appendChild(imageButton);
            }

            // Mettre à jour le statut
            statusText.textContent = `${categoryData.name} - ${categoryData.count} image(s)`;

            // Réinitialiser la sélection
            selectedImageIndex = -1;
            document.getElementById('selectBtn').disabled = true;
            document.getElementById('applyWallpaperBtn').disabled = true;
        }

        function selectImage(index, buttonElement) {
            // Retirer la sélection précédente
            document.querySelectorAll('.image-button').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Sélectionner la nouvelle image
            buttonElement.classList.add('selected');
            selectedImageIndex = index;
            
            // Stocker la couleur de l'image sélectionnée
            const categoryData = categories[currentCategory];
            selectedImageColor = categoryData.colors[index];

            // Activer les boutons
            document.getElementById('selectBtn').disabled = false;
            document.getElementById('applyWallpaperBtn').disabled = false;

            // Mettre à jour le statut
            const statusText = document.getElementById('statusText');
            statusText.textContent = `Image sélectionnée: Image ${index + 1}.jpg`;
        }

        function updateDemoBubble(categoryName, color) {
            const bubble = document.getElementById('demoBubble');
            const labelText = document.getElementById('bubbleLabelText');
            
            if (bubble && labelText) {
                // Mettre à jour la couleur de fond de la bulle
                bubble.style.background = color;
                
                // Garder le texte de l'étiquette fixe
                labelText.textContent = 'Ma Bulle';
            }
        }

        function resetDemoBubble() {
            const bubble = document.getElementById('demoBubble');
            const labelText = document.getElementById('bubbleLabelText');
            const demoCanvas = document.querySelector('.demo-bubble-canvas');
            
            if (bubble && labelText) {
                // Réinitialiser la couleur de fond de la bulle
                bubble.style.background = '#2D2D30';
                
                // Réinitialiser le texte de l'étiquette
                labelText.textContent = 'Ma Bulle';
            }
            
            if (demoCanvas) {
                // Réinitialiser la couleur de fond du canvas
                demoCanvas.style.backgroundColor = '#2D2D2D';
            }
        }

        // Gestionnaires d'événements pour les boutons
        document.getElementById('selectBtn').addEventListener('click', function() {
            if (selectedImageIndex >= 0) {
                // Le message d'alerte a été supprimé pour la démonstration
            }
        });

        document.getElementById('applyWallpaperBtn').addEventListener('click', function() {
            if (selectedImageIndex >= 0) {
                // Le message d'alerte a été supprimé pour la démonstration
            }
        });

        document.getElementById('cancelBtn').addEventListener('click', function() {
            closeWindow();
        });

        function closeWindow() {
            window.close();
        }
    </script>
</body>
</html>
